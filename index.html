<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proses Normalisasi Dapodik BPMP Kalbar 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <div class="max-w-5xl mx-auto py-12 px-4">
        <!-- Header with Logos -->
        <div class="flex flex-col items-center mb-10">
            <div class="flex items-center justify-center space-x-8 mb-8">
                <!-- Logo Kemendikdasmen -->
                <img src="Logo Kemendikdasmen BARU.png" alt="Logo Kemendikdasmen" class="h-30 w-auto object-contain" onerror="this.style.display='none'">
                <!-- Logo Tambahan 1 -->
                <img src="image_7dc36f.png" alt="Logo BPMP" class="h-30 w-auto object-contain" onerror="this.style.display='none'">
                <!-- Logo Tambahan 2 -->
                <img src="image_7dcf6c.png" alt="Logo Kalbar" class="h-30 w-auto object-contain" onerror="this.style.display='none'">
            </div>
            <div class="text-center">
                <h1 class="text-3xl font-bold text-slate-800 mb-2">Proses Normalisasi Dapodik BPMP Kalbar 2026</h1>
                <p class="text-slate-600 text-sm italic">Pembersihan Ganda, Perhitungan Usia, dan Lookup Satuan Pendidikan</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Upload File Dapodik -->
            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center">
                    <span class="bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">1</span>
                    File Data Guru Dapodik
                </h3>
                <div id="drop-area-1" class="border-2 border-dashed border-slate-200 rounded-xl p-6 text-center hover:border-blue-500 transition-colors cursor-pointer bg-slate-50">
                    <input type="file" id="fileInputDapodik" class="hidden" accept=".xlsx, .xls">
                    <div id="prompt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-slate-400 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-sm font-medium text-slate-600">Klik untuk Unggah Dapodik</p>
                    </div>
                    <div id="info-1" class="hidden">
                        <p id="name-1" class="text-sm font-bold text-blue-600 truncate"></p>
                        <p class="text-[10px] text-slate-400 mt-1">File siap diproses</p>
                    </div>
                </div>
            </div>

            <!-- Upload File Satuan Pendidikan -->
            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center">
                    <span class="bg-green-100 text-green-600 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">2</span>
                    File Data Satuan Pendidikan
                </h3>
                <div id="drop-area-2" class="border-2 border-dashed border-slate-200 rounded-xl p-6 text-center hover:border-green-500 transition-colors cursor-pointer bg-slate-50">
                    <input type="file" id="fileInputSatpen" class="hidden" accept=".xlsx, .xls">
                    <div id="prompt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-slate-400 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        <p class="text-sm font-medium text-slate-600">Klik untuk Unggah Satpen</p>
                    </div>
                    <div id="info-2" class="hidden">
                        <p id="name-2" class="text-sm font-bold text-green-600 truncate"></p>
                        <p class="text-[10px] text-slate-400 mt-1">Data referensi dimuat</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Card Actions -->
        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 p-8 mb-8">
            <div id="processContainer" class="text-center">
                <div id="warningText" class="text-amber-600 text-sm mb-4 font-medium">
                    Silakan unggah kedua file di atas untuk mengaktifkan tombol proses.
                </div>
                <button id="btnProcess" disabled class="w-full flex items-center justify-center space-x-2 bg-slate-200 text-slate-500 font-bold py-4 px-6 rounded-xl transition cursor-not-allowed">
                    <span id="btnProcessText">Mulai Proses Normalisasi</span>
                    <svg id="btnProcessIcon" class="hidden spinner h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>

            <!-- Download Buttons -->
            <div id="resultActions" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                <button id="downloadClean" class="flex items-center justify-center space-x-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-4 px-6 rounded-xl transition shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>Unduh Hasil Normalisasi</span>
                </button>
                <button id="downloadResidu" class="hidden flex items-center justify-center space-x-2 bg-rose-600 hover:bg-rose-700 text-white font-semibold py-4 px-6 rounded-xl transition shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span>Unduh Residu-Data</span>
                </button>
            </div>
        </div>

        <!-- Stats Section -->
        <div id="summaryTable" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl border border-slate-200 text-center shadow-sm">
                <p class="text-xs text-slate-500 mb-1 font-bold">Total Input</p>
                <p id="statTotal" class="text-xl font-bold text-slate-800">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200 text-center shadow-sm">
                <p class="text-xs text-slate-500 mb-1 font-bold">Data Bersih</p>
                <p id="statValid" class="text-xl font-bold text-green-600">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200 text-center shadow-sm">
                <p class="text-xs text-slate-500 mb-1 font-bold">Data Residu</p>
                <p id="statResidu" class="text-xl font-bold text-rose-600">0</p>
            </div>
            <div class="bg-white p-4 rounded-xl border border-slate-200 text-center shadow-sm">
                <p class="text-xs text-slate-500 mb-1 font-bold">Waktu Proses</p>
                <p id="statTime" class="text-sm font-bold text-blue-600">0ms</p>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-slate-400 text-xs mt-12 italic border-t pt-6">
            BPMP Provinsi Kalimantan Barat &copy; 2026 - Versi Logika 7.0 (Age & Lookup Implemented)
        </div>
    </div>

    <script>
        // State
        let rawDapodik = [];
        let satpenLookup = {};
        let headerDapodik = [];
        let processedDataRows = [];
        let residuDataRows = [];

        // Elements
        const fileInDapodik = document.getElementById('fileInputDapodik');
        const fileInSatpen = document.getElementById('fileInputSatpen');
        const btnProcess = document.getElementById('btnProcess');
        const warningText = document.getElementById('warningText');

        // UI Interactions
        document.getElementById('drop-area-1').onclick = () => fileInDapodik.click();
        document.getElementById('drop-area-2').onclick = () => fileInSatpen.click();

        fileInDapodik.onchange = (e) => handleUpload(e, 'dapodik');
        fileInSatpen.onchange = (e) => handleUpload(e, 'satpen');

        function handleUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array', raw: false });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

                if (type === 'dapodik') {
                    headerDapodik = json[0];
                    rawDapodik = json.slice(1);
                    document.getElementById('prompt-1').classList.add('hidden');
                    document.getElementById('info-1').classList.remove('hidden');
                    document.getElementById('name-1').innerText = file.name;
                } else {
                    satpenLookup = {};
                    json.slice(1).forEach(row => {
                        const key = String(row[0] || "").trim(); 
                        if (key) satpenLookup[key] = row[2]; 
                    });
                    document.getElementById('prompt-2').classList.add('hidden');
                    document.getElementById('info-2').classList.remove('hidden');
                    document.getElementById('name-2').innerText = file.name;
                }
                checkReadyState();
            };
            reader.readAsArrayBuffer(file);
        }

        function checkReadyState() {
            if (rawDapodik.length > 0 && Object.keys(satpenLookup).length > 0) {
                btnProcess.disabled = false;
                btnProcess.classList.remove('bg-slate-200', 'text-slate-500', 'cursor-not-allowed');
                btnProcess.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700', 'cursor-pointer');
                warningText.innerText = "Kedua file terdeteksi. Sistem siap memproses data.";
                warningText.classList.replace('text-amber-600', 'text-green-600');
            }
        }

        function calculateAge(birthDateStr) {
            if (!birthDateStr || birthDateStr === "") return null;
            const today = new Date();
            const birthDate = new Date(birthDateStr);
            if (isNaN(birthDate.getTime())) return null;

            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function runNormalisasi() {
            const newHeader = [...headerDapodik];
            while (newHeader.length < 30) newHeader.push(""); 
            newHeader[30] = "Usia 56";
            newHeader[31] = "Usia 57";
            newHeader[32] = "Usia 58";
            newHeader[33] = "Usia 59";
            newHeader[34] = "Usia 60";
            newHeader[35] = "Bentuk Pendidikan";

            processedDataRows = [newHeader];
            residuDataRows = [headerDapodik];

            const idxNIK = 1;        
            const idxTglLahir = 6;   
            const idxStatusTugas = 7; 
            const idxNPSN = 9;       
            const idxPendidikan = 19; 
            const idxSertifikasi = 21;
            const idxKepegawaian = 22;

            const nikCountMap = {};
            rawDapodik.forEach(row => {
                let nik = String(row[idxNIK] || "").replace(/\D/g, '');
                if (nik !== "" && nik !== "0") nikCountMap[nik] = (nikCountMap[nik] || 0) + 1;
            });

            rawDapodik.forEach(row => {
                const nikRaw = String(row[idxNIK] || "").trim();
                const nikClean = nikRaw.replace(/\D/g, '');
                const statusTugasRaw = String(row[idxStatusTugas] || "").toLowerCase();

                const isNikEmpty = (nikClean === "" || nikRaw === "-" || isNaN(nikClean));
                const isDuplicate = nikCountMap[nikClean] > 1;
                const isNonInduk = statusTugasRaw.includes("non") && statusTugasRaw.includes("induk");

                if (isNikEmpty || (isDuplicate && isNonInduk)) {
                    residuDataRows.push(row);
                    return;
                }

                let d = [...row];
                d[idxStatusTugas] = "Induk";

                const edu = String(d[idxPendidikan] || "").toUpperCase();
                const keysHigh = ["S1", "S2", "S3", "D4", "PROFESI"];
                d[idxPendidikan] = keysHigh.some(k => edu.includes(k)) ? "> S1" : "< S1";

                const cert = String(d[idxSertifikasi] || "").trim();
                d[idxSertifikasi] = (cert === "" || cert.toLowerCase() === "null") ? "Belum Sertifikasi" : "Sudah Sertifikasi";

                const emp = String(d[idxKepegawaian] || "").toUpperCase();
                if (emp.includes("PNS") || emp.includes("CPNS")) {
                    d[idxKepegawaian] = "PNS";
                } else if (emp.includes("HONOR DAERAH")) {
                    d[idxKepegawaian] = "Honor Daerah";
                } else if (emp.includes("PPPK") || emp.includes("GTY") || emp.includes("PTY")) {
                } else {
                    d[idxKepegawaian] = "Honor Sekolah";
                }

                const age = calculateAge(d[idxTglLahir]);
                d[30] = (age === 56) ? 1 : 0;
                d[31] = (age === 57) ? 1 : 0;
                d[32] = (age === 58) ? 1 : 0;
                d[33] = (age === 59) ? 1 : 0;
                d[34] = (age === 60) ? 1 : 0;

                const npsnKey = String(d[idxNPSN] || "").trim();
                d[35] = satpenLookup[npsnKey] || "NULL";

                processedDataRows.push(d);
            });
        }

        btnProcess.onclick = async () => {
            btnProcess.disabled = true;
            document.getElementById('btnProcessText').innerText = "Sedang Melakukan Normalisasi...";
            document.getElementById('btnProcessIcon').classList.remove('hidden');

            await new Promise(r => setTimeout(r, 1000));
            const start = performance.now();
            runNormalisasi();
            const end = performance.now();

            document.getElementById('resultActions').classList.remove('hidden');
            document.getElementById('summaryTable').classList.remove('hidden');
            document.getElementById('downloadResidu').classList.toggle('hidden', residuDataRows.length <= 1);
            
            document.getElementById('statTotal').innerText = rawDapodik.length;
            document.getElementById('statValid').innerText = processedDataRows.length - 1;
            document.getElementById('statResidu').innerText = residuDataRows.length - 1;
            document.getElementById('statTime').innerText = Math.round(end - start) + "ms";

            document.getElementById('btnProcessText').innerText = "Normalisasi Selesai";
            document.getElementById('btnProcessIcon').classList.add('hidden');
        };

        function resetApp() {
            window.location.reload();
        }

        document.getElementById('downloadClean').onclick = () => {
            const ws = XLSX.utils.aoa_to_sheet(processedDataRows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Normalisasi_2026");
            XLSX.writeFile(wb, "Dapodik_Normal_BPMP_2026.xlsx");
        };

        document.getElementById('downloadResidu').onclick = () => {
            const ws = XLSX.utils.aoa_to_sheet(residuDataRows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Residu_Data");
            XLSX.writeFile(wb, "Residu-Data.xlsx");
        };
    </script>
</body>
</html>
